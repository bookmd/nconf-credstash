machine:
  node:
    version: 5.5.0  
  services:
    - docker

dependencies:
  pre:
    - sudo apt-get install openssh-client build-essential libssl-dev libffi-dev python-dev
    - echo "$SSH_ID_RSA" >> ~/.ssh/credstash_ssh_key
    - echo "$SSH_ID_RSA_PUB" >> ~/.ssh/credstash_ssh_key.pub
    - echo "" >> ~/.ssh/config
    - echo "Host credstash_host" >> ~/.ssh/config
    - echo "  IdentitiesOnly yes" >> ~/.ssh/config
    - echo "  HostName localhost" >> ~/.ssh/config
    - echo "  Port 24" >> ~/.ssh/config
    - echo "  IdentityFile ~/.ssh/credstash_ssh_key" >> ~/.ssh/config
    - pip install credstash
    - credstash setup

test:
  override:
    - docker run -itd -p 24:24 -e SSH_PORT=24 --env-file <(env | grep AWS) -v ~/.ssh/credstash_ssh_key.pub:/root/.ssh/authorized_keys --name credstash_host bookmd/docker-credstash-host
    - sudo lxc-attach -n "$(docker inspect --format "{{.Id}}" credstash_host)" -- bash -c "credstash setup"
    - CREDSTAH_HOST=credstash_host
    - npm test

general:
  artifacts:
    - ./coverage